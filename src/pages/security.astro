---
// Página de seguridad para Sensus
---

import BaseLayout from '../layouts/BaseLayout.astro';
import SecurityDashboard from '../components/security/SecurityDashboard.astro';
import PrivacyDashboard from '../components/security/PrivacyDashboard.astro';

const pageTitle = 'Seguridad y Compliance';
const pageDescription = 'Dashboard de seguridad y cumplimiento para Sensus';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main class="security-page">
    <div class="page-header">
      <h1>Seguridad y Compliance</h1>
      <p>Dashboard de seguridad y cumplimiento para Sensus</p>
    </div>

    <div class="security-content">
      <div class="security-tabs">
        <button class="tab-button active" data-tab="security">Seguridad</button>
        <button class="tab-button" data-tab="privacy">Privacidad</button>
        <button class="tab-button" data-tab="compliance">Cumplimiento</button>
      </div>

      <div class="tab-content">
        <div class="tab-panel active" id="security-panel">
          <SecurityDashboard />
        </div>

        <div class="tab-panel" id="privacy-panel">
          <PrivacyDashboard />
        </div>

        <div class="tab-panel" id="compliance-panel">
          <div class="compliance-dashboard">
            <div class="dashboard-header">
              <h2>Dashboard de Cumplimiento</h2>
              <div class="dashboard-controls">
                <button id="refresh-compliance-btn" class="btn btn-primary">Actualizar</button>
                <button id="export-compliance-btn" class="btn btn-secondary">Exportar</button>
                <button id="run-compliance-check-btn" class="btn btn-outline">Ejecutar Verificación</button>
              </div>
            </div>

            <div class="dashboard-grid">
              <!-- Estado de cumplimiento -->
              <div class="metric-card">
                <h3>Estado de Cumplimiento</h3>
                <div class="compliance-overview">
                  <div class="compliance-item">
                    <span class="compliance-label">GDPR</span>
                    <span class="compliance-score" id="gdpr-score">95%</span>
                    <span class="compliance-status compliant">Cumple</span>
                  </div>
                  <div class="compliance-item">
                    <span class="compliance-label">CCPA</span>
                    <span class="compliance-score" id="ccpa-score">88%</span>
                    <span class="compliance-status compliant">Cumple</span>
                  </div>
                  <div class="compliance-item">
                    <span class="compliance-label">LGPD</span>
                    <span class="compliance-score" id="lgpd-score">92%</span>
                    <span class="compliance-status compliant">Cumple</span>
                  </div>
                </div>
              </div>

              <!-- Verificaciones de cumplimiento -->
              <div class="metric-card">
                <h3>Verificaciones de Cumplimiento</h3>
                <div class="compliance-checks" id="compliance-checks">
                  <div class="check-item">
                    <span class="check-name">GDPR Data Protection</span>
                    <span class="check-status compliant">Cumple</span>
                    <span class="check-date">2024-01-15</span>
                  </div>
                  <div class="check-item">
                    <span class="check-name">GDPR Consent Management</span>
                    <span class="check-status compliant">Cumple</span>
                    <span class="check-date">2024-01-15</span>
                  </div>
                  <div class="check-item">
                    <span class="check-name">CCPA Privacy Rights</span>
                    <span class="check-status compliant">Cumple</span>
                    <span class="check-date">2024-01-15</span>
                  </div>
                </div>
              </div>

              <!-- Hallazgos -->
              <div class="metric-card">
                <h3>Hallazgos Recientes</h3>
                <div class="findings-list" id="findings-list">
                  <div class="finding-item">
                    <span class="finding-type">Recomendación</span>
                    <span class="finding-description">Implementar auditoría adicional para datos sensibles</span>
                    <span class="finding-severity medium">Medio</span>
                  </div>
                  <div class="finding-item">
                    <span class="finding-type">Observación</span>
                    <span class="finding-description">Mejorar documentación de procesos de datos</span>
                    <span class="finding-severity low">Bajo</span>
                  </div>
                </div>
              </div>

              <!-- Incidentes de seguridad -->
              <div class="metric-card">
                <h3>Incidentes de Seguridad</h3>
                <div class="incidents-list" id="incidents-list">
                  <div class="incident-item">
                    <span class="incident-severity low">Bajo</span>
                    <span class="incident-title">Intento de acceso no autorizado</span>
                    <span class="incident-status resolved">Resuelto</span>
                  </div>
                </div>
              </div>

              <!-- Reportes -->
              <div class="metric-card">
                <h3>Reportes de Auditoría</h3>
                <div class="reports-list" id="reports-list">
                  <div class="report-item">
                    <span class="report-title">Reporte Mensual - Enero 2024</span>
                    <span class="report-date">2024-01-31</span>
                    <span class="report-status completed">Completado</span>
                  </div>
                </div>
              </div>

              <!-- Configuración de cumplimiento -->
              <div class="metric-card">
                <h3>Configuración de Cumplimiento</h3>
                <div class="compliance-config">
                  <div class="config-item">
                    <label>
                      <input type="checkbox" id="enable-gdpr-monitoring" checked>
                      Monitoreo GDPR
                    </label>
                  </div>
                  <div class="config-item">
                    <label>
                      <input type="checkbox" id="enable-ccpa-monitoring" checked>
                      Monitoreo CCPA
                    </label>
                  </div>
                  <div class="config-item">
                    <label>
                      <input type="checkbox" id="enable-automated-checks" checked>
                      Verificaciones Automáticas
                    </label>
                  </div>
                  <div class="config-item">
                    <label>
                      <input type="checkbox" id="enable-incident-tracking" checked>
                      Seguimiento de Incidentes
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  class SecurityPage {
    constructor() {
      this.init();
    }

    private init(): void {
      this.setupTabSwitching();
      this.setupComplianceControls();
    }

    private setupTabSwitching(): void {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabPanels = document.querySelectorAll('.tab-panel');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.dataset.tab;

          // Remover clase active de todos los botones y paneles
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabPanels.forEach(panel => panel.classList.remove('active'));

          // Agregar clase active al botón y panel seleccionados
          button.classList.add('active');
          document.getElementById(`${tabName}-panel`)?.classList.add('active');
        });
      });
    }

    private setupComplianceControls(): void {
      // Botón de actualizar
      document.getElementById('refresh-compliance-btn')?.addEventListener('click', () => {
        this.updateComplianceDashboard();
      });

      // Botón de exportar
      document.getElementById('export-compliance-btn')?.addEventListener('click', () => {
        this.exportComplianceData();
      });

      // Botón de ejecutar verificación
      document.getElementById('run-compliance-check-btn')?.addEventListener('click', () => {
        this.runComplianceCheck();
      });

      // Configuración de cumplimiento
      document.getElementById('enable-gdpr-monitoring')?.addEventListener('change', (e) => {
        this.toggleGDPRMonitoring((e.target as HTMLInputElement).checked);
      });

      document.getElementById('enable-ccpa-monitoring')?.addEventListener('change', (e) => {
        this.toggleCCPAMonitoring((e.target as HTMLInputElement).checked);
      });

      document.getElementById('enable-automated-checks')?.addEventListener('change', (e) => {
        this.toggleAutomatedChecks((e.target as HTMLInputElement).checked);
      });

      document.getElementById('enable-incident-tracking')?.addEventListener('change', (e) => {
        this.toggleIncidentTracking((e.target as HTMLInputElement).checked);
      });
    }

    private async updateComplianceDashboard(): Promise<void> {
      try {
        // Simular actualización de datos de cumplimiento
        const gdprScore = Math.floor(Math.random() * 20) + 80;
        const ccpaScore = Math.floor(Math.random() * 20) + 80;
        const lgpdScore = Math.floor(Math.random() * 20) + 80;

        this.updateElement('gdpr-score', `${gdprScore}%`);
        this.updateElement('ccpa-score', `${ccpaScore}%`);
        this.updateElement('lgpd-score', `${lgpdScore}%`);

        console.log('Compliance dashboard updated');
      } catch (error) {
        console.error('Error updating compliance dashboard:', error);
      }
    }

    private async exportComplianceData(): Promise<void> {
      try {
        const data = {
          timestamp: new Date().toISOString(),
          compliance: {
            gdpr: { score: 95, status: 'compliant' },
            ccpa: { score: 88, status: 'compliant' },
            lgpd: { score: 92, status: 'compliant' },
          },
          checks: [
            { name: 'GDPR Data Protection', status: 'compliant', date: '2024-01-15' },
            { name: 'GDPR Consent Management', status: 'compliant', date: '2024-01-15' },
            { name: 'CCPA Privacy Rights', status: 'compliant', date: '2024-01-15' },
          ],
          findings: [
            { type: 'recommendation', description: 'Implementar auditoría adicional', severity: 'medium' },
            { type: 'observation', description: 'Mejorar documentación', severity: 'low' },
          ],
          incidents: [
            { severity: 'low', title: 'Intento de acceso no autorizado', status: 'resolved' },
          ],
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `compliance-data-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Error exporting compliance data:', error);
      }
    }

    private async runComplianceCheck(): Promise<void> {
      try {
        console.log('Running compliance check...');
        // Simular ejecución de verificación de cumplimiento
        setTimeout(() => {
          console.log('Compliance check completed');
        }, 2000);
      } catch (error) {
        console.error('Error running compliance check:', error);
      }
    }

    private toggleGDPRMonitoring(enabled: boolean): void {
      console.log('GDPR monitoring toggled:', enabled);
    }

    private toggleCCPAMonitoring(enabled: boolean): void {
      console.log('CCPA monitoring toggled:', enabled);
    }

    private toggleAutomatedChecks(enabled: boolean): void {
      console.log('Automated checks toggled:', enabled);
    }

    private toggleIncidentTracking(enabled: boolean): void {
      console.log('Incident tracking toggled:', enabled);
    }

    private updateElement(id: string, value: string): void {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
      }
    }
  }

  // Inicializar página cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', () => {
    new SecurityPage();
  });
</script>

<style>
  .security-page {
    min-height: 100vh;
    background: var(--color-background);
  }

  .page-header {
    text-align: center;
    padding: 2rem 1rem;
    background: var(--color-surface);
    border-bottom: 1px solid var(--color-border);
  }

  .page-header h1 {
    margin: 0 0 0.5rem 0;
    color: var(--color-text-primary);
    font-size: 2.5rem;
    font-weight: 700;
  }

  .page-header p {
    margin: 0;
    color: var(--color-text-secondary);
    font-size: 1.125rem;
  }

  .security-content {
    padding: 2rem 1rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .security-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
  }

  .tab-button {
    padding: 1rem 2rem;
    border: none;
    background: transparent;
    color: var(--color-text-secondary);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }

  .tab-button:hover {
    color: var(--color-text-primary);
  }

  .tab-button.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .tab-content {
    position: relative;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }

  .compliance-dashboard {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .dashboard-controls {
    display: flex;
    gap: 1rem;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
  }

  .metric-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
  }

  .metric-card h3 {
    margin: 0 0 1rem 0;
    color: var(--color-text-primary);
  }

  .compliance-overview {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .compliance-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--color-surface-secondary);
    border-radius: var(--border-radius);
  }

  .compliance-label {
    font-weight: 500;
    color: var(--color-text-primary);
  }

  .compliance-score {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-primary);
  }

  .compliance-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    color: white;
    font-weight: 500;
  }

  .compliance-status.compliant {
    background: var(--color-success);
  }

  .compliance-status.non-compliant {
    background: var(--color-error);
  }

  .compliance-status.partial {
    background: var(--color-warning);
  }

  .compliance-checks,
  .findings-list,
  .incidents-list,
  .reports-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .check-item,
  .finding-item,
  .incident-item,
  .report-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--color-surface-secondary);
    border-radius: var(--border-radius);
  }

  .check-name,
  .finding-description,
  .incident-title,
  .report-title {
    font-weight: 500;
    color: var(--color-text-primary);
  }

  .check-status,
  .finding-severity,
  .incident-severity,
  .report-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    color: white;
  }

  .check-status.compliant {
    background: var(--color-success);
  }

  .finding-severity.low {
    background: var(--color-info);
  }

  .finding-severity.medium {
    background: var(--color-warning);
  }

  .finding-severity.high {
    background: var(--color-error);
  }

  .incident-severity.low {
    background: var(--color-info);
  }

  .incident-severity.medium {
    background: var(--color-warning);
  }

  .incident-severity.high {
    background: var(--color-error);
  }

  .incident-status.resolved {
    background: var(--color-success);
  }

  .report-status.completed {
    background: var(--color-success);
  }

  .check-date,
  .report-date {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .compliance-config {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .config-item {
    display: flex;
    align-items: center;
  }

  .config-item label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: var(--color-text-primary);
  }

  .config-item input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
  }

  @media (max-width: 768px) {
    .page-header h1 {
      font-size: 2rem;
    }

    .page-header p {
      font-size: 1rem;
    }

    .security-content {
      padding: 1rem 0.5rem;
    }

    .security-tabs {
      flex-direction: column;
    }

    .tab-button {
      padding: 0.75rem 1rem;
    }

    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .compliance-config {
      grid-template-columns: 1fr;
    }
  }
</style>
